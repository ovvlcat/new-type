#include <windows.h>
#include <iostream>
#include <vector>
#include <string>

using namespace std;

// ?????? ?????? ????  
typedef struct
{
    float x, y, width, height, rad, dx, dy, speed, gravity, jumpForce;
    float verticalVelocity;  // ???????????? ????????
    bool isJumping;         // ???? ??????
    bool isOnGround;        // ?? ????? ??
    HBITMAP hBitmap;//????? ? ??????? ?????? 
} sprite;

typedef struct //????????? ??? ????????
{
    float x, y, width, height;
    HBITMAP hBitmap;
    bool isSolid;           // ????????? ?? ????????? ?????
} platform;

typedef struct //????????? ??? ???????
{
    float groundLevel;      // ??????? ?????
    vector<platform> platforms; // ????????? ? ???????
    HBITMAP background;     // ??? ???????
} location;

sprite racket;//??????? ??????
location currentLocation;

struct
{
    int score, balls;//?????????? ????????? ????? ? ?????????? "??????"
    bool action = false;//????????? - ???????? (????? ?????? ?????? ??????) ??? ????
} game;

struct
{
    HWND hWnd;//????? ????
    HDC device_context, context;// ??? ????????? ?????????? (??? ???????????)
    int width, height;//???? ???????? ??????? ???? ??????? ??????? ?????????
}   window;

// ??????? ??? ?????????????? string ? wstring
std::wstring stringToWString(const std::string& str) {
    if (str.empty()) return std::wstring();
    int size_needed = MultiByteToWideChar(CP_UTF8, 0, &str[0], (int)str.size(), NULL, 0);
    std::wstring wstrTo(size_needed, 0);
    MultiByteToWideChar(CP_UTF8, 0, &str[0], (int)str.size(), &wstrTo[0], size_needed);
    return wstrTo;
}

// ??????? ??? ?????????????? int ? wstring
std::wstring intToWString(int value) {
    wchar_t buffer[32];
    _itow_s(value, buffer, 10);
    return std::wstring(buffer);
}

// ??????? ???????? ???????? AABB (Axis-Aligned Bounding Box)
bool CheckCollision(float x1, float y1, float w1, float h1,
    float x2, float y2, float w2, float h2)
{
    return (x1 < x2 + w2 &&
        x1 + w1 > x2 &&
        y1 < y2 + h2 &&
        y1 + h1 > y2);
}

// ???????? ???????? ? ?????????? ????? (??????? ?? ?????????)
bool CheckPlatformCollisionFromTop(sprite* player, platform* plat)
{
    float playerBottom = player->y + player->height;
    float playerNextBottom = playerBottom + player->verticalVelocity; // ?????????????? ??????? ?????

    // ?????????, ????????? ?? ????? ??? ?????????? ? ?????? ?? ??
    if (player->verticalVelocity > 0 &&
        playerNextBottom >= plat->y &&
        playerBottom <= plat->y &&
        player->x + player->width > plat->x &&
        player->x < plat->x + plat->width)
    {
        return true;
    }
    return false;
}

// ???????? ???????? ? ?????????? ?????
bool CheckPlatformCollisionFromSide(sprite* player, platform* plat)
{
    // ????????? ????? ???????
    if (player->x + player->width > plat->x &&
        player->x < plat->x &&
        player->y + player->height > plat->y &&
        player->y < plat->y + plat->height)
    {
        return true;
    }

    // ????????? ?????? ???????
    if (player->x < plat->x + plat->width &&
        player->x + player->width > plat->x + plat->width &&
        player->y + player->height > plat->y &&
        player->y < plat->y + plat->height)
    {
        return true;
    }

    return false;
}

void UpdatePhysics()
{
    // ????????? ?????????? ??????? ??? ????????? ????????
    float prevY = racket.y;

    // ???? ?? ?? ????? - ????????? ??????????
    if (!racket.isOnGround)
    {
        racket.verticalVelocity += racket.gravity;
        racket.y += racket.verticalVelocity;
    }

    // ????????? ???????? ? ??????
    if (racket.y + racket.height >= currentLocation.groundLevel)
    {
        racket.y = currentLocation.groundLevel - racket.height;
        racket.isOnGround = true;
        racket.isJumping = false;
        racket.verticalVelocity = 0;
    }
    else
    {
        racket.isOnGround = false;
    }

    // ????????? ???????? ?? ????? ???????????
    for (auto& plat : currentLocation.platforms)
    {
        // ???????? ??????? ?? ????????? ??????
        if (CheckPlatformCollisionFromTop(&racket, &plat))
        {
            float overlapleft = plat.x - racket.x;     //????????? ?????? ???, ??????????? ? ???????? ????????? ??????????
            float overlapright = plat.x - racket.x;
            float overlapup = plat.y - racket.y;
            float overlapdown = plat.y - racket.y;

            float minoverlapx = min(overlapleft, overlapright);
            float minoverlapy = min(overlapup, overlapdown);

            float Itog = min(minoverlapy, minoverlapx);

            if (Itog == overlapleft)
            {
                racket.x = plat.x - racket.width;
            }
            else if (Itog == overlapright)
            {
                racket.x = plat.x + racket.width;
            }
            else if (Itog == overlapup)
            {
                racket.y = plat.y - racket.height;
            }
            else if (Itog == overlapdown)
            {
                racket.y = plat.y + racket.height;
            }

            /*if (minoverlapx < minoverlapy)
            {
               racket.x = -plat.x;
            }
            else
            {
               racket.y = -plat.y;
            }*/
            //    racket.y = plat.y - racket.height; // ?????? ?????? ?? ?????????
            //    racket.isOnGround = true;
            //    racket.isJumping = false;
            //    racket.verticalVelocity = 0;
            //    break; // ??????? ????? ?????? ????????
            //}

            // //???????? ???????? ????? (????????????? ????????)
            //if (CheckPlatformCollisionFromSide(&racket, &plat))
            //{
            //    // ??????????? ?????? ?? ?????????
            //    if (racket.x + racket.width > plat.x && racket.x < plat.x)
            //    {
            //        racket.x = plat.x - racket.width - 1; // ?????????? ?????
            //    }
            //    else if (racket.x < plat.x + plat.width && racket.x + racket.width > plat.x + plat.width)
            //    {
            //        racket.x = plat.x + plat.width + 1; // ?????????? ??????
            //    }
        }
    }
}

void Jump()
{
    if (racket.isOnGround)
    {
        racket.isJumping = true;
        racket.isOnGround = false;
        racket.verticalVelocity = -racket.jumpForce; // ????????????? ???????? - ???????? ?????
    }
}

void InitGame()
{
    // ???????? ???????? ? ?????????????? ??????? ?????
    racket.hBitmap = (HBITMAP)LoadImageW(NULL, L"rash.bmp", IMAGE_BITMAP, 0, 0, LR_LOADFROMFILE);
    currentLocation.background = (HBITMAP)LoadImageW(NULL, L"back2.bmp", IMAGE_BITMAP, 0, 0, LR_LOADFROMFILE);

    // ????????????? ??????
    racket.width = 128;
    racket.height = 210;
    racket.speed = 15;
    racket.x = window.width / 2.;
    racket.y = window.height - racket.height - 100; // ?????? ???? ?????
    racket.jumpForce = 40.0f;
    racket.gravity = 0.8f;
    racket.verticalVelocity = 0;
    racket.isJumping = false;
    racket.isOnGround = false;

    // ????????????? ???????
    currentLocation.groundLevel = window.height - 100; // ??????? ?????

    // ??????? ????????? ????????
    platform plat1;
    plat1.x = 300;
    plat1.y = 500;
    plat1.width = 200;
    plat1.height = 30;
    plat1.hBitmap = NULL; // ????? ????????? ????????
    plat1.isSolid = true;

    platform plat2;
    plat2.x = 600;
    plat2.y = 400;
    plat2.width = 150;
    plat2.height = 30;
    plat2.hBitmap = NULL;
    plat2.isSolid = true;

    platform plat3;
    plat3.x = 200;
    plat3.y = 300;
    plat3.width = 100;
    plat3.height = 30;
    plat3.hBitmap = NULL;
    plat3.isSolid = true;

    // ????????? ????????? ? ???????
    currentLocation.platforms.push_back(plat1);
    currentLocation.platforms.push_back(plat2);
    currentLocation.platforms.push_back(plat3);
}

void ShowScore()
{
    // ????????? ?????? ? ??????
    SetTextColor(window.context, RGB(160, 160, 160));
    SetBkColor(window.context, RGB(0, 0, 0));
    SetBkMode(window.context, TRANSPARENT);

    // ???????? ?????? ? ??????? ???????
    HFONT hFont = CreateFontW(24, 0, 0, 0, FW_BOLD, 0, 0, 0,
        DEFAULT_CHARSET, OUT_DEFAULT_PRECIS,
        CLIP_DEFAULT_PRECIS, DEFAULT_QUALITY,
        DEFAULT_PITCH | FF_DONTCARE, L"CALIBRI");
    HFONT hOldFont = (HFONT)SelectObject(window.context, hFont);

    // ?????????? ?????????? Y
    wstring textY = L"HeroY: " + intToWString((int)racket.y);
    TextOutW(window.context, 10, 10, textY.c_str(), textY.length());

    // ?????????? ?????????? X
    wstring textX = L"HeroX: " + intToWString((int)racket.x);
    TextOutW(window.context, 10, 40, textX.c_str(), textX.length());

    // ?????????? ?????????
    wstring state = racket.isOnGround ? L"On Ground" : L"In Air";
    TextOutW(window.context, 10, 70, state.c_str(), state.length());

    // ?????????? ????????? ??????
    wstring jumpState = racket.isJumping ? L"Jumping" : L"Not Jumping";
    TextOutW(window.context, 10, 100, jumpState.c_str(), jumpState.length());

    // ?????????? ???????????? ????????
    wstring velocity = L"VelocityY: " + intToWString((int)racket.verticalVelocity);
    TextOutW(window.context, 10, 130, velocity.c_str(), velocity.length());

    // ??????????????? ?????? ????? ? ??????? ?????????
    SelectObject(window.context, hOldFont);
    DeleteObject(hFont);
}

void ProcessInput()
{
    // ?????????????? ????????
    if (GetAsyncKeyState(VK_LEFT)) racket.x -= racket.speed;
    if (GetAsyncKeyState(VK_RIGHT)) racket.x += racket.speed;

    bool spaceWasPressed = false;
    // ?????? ?? ?????? ??? ??????? ?????
    if ((GetAsyncKeyState(VK_UP) & 0x8000))
    {
        if (!spaceWasPressed)
        {
            Jump();
            spaceWasPressed = true;
        }
    }
    spaceWasPressed = false;
}

void ShowBitmap(HDC hDC, int x, int y, int x1, int y1, HBITMAP hBitmapBall, bool alpha = false)
{
    HBITMAP hbm, hOldbm;
    HDC hMemDC;
    BITMAP bm;

    hMemDC = CreateCompatibleDC(hDC);
    hOldbm = (HBITMAP)SelectObject(hMemDC, hBitmapBall);

    if (hOldbm)
    {
        GetObject(hBitmapBall, sizeof(BITMAP), (LPSTR)&bm);
        StretchBlt(hDC, x, y, x1, y1, hMemDC, 0, 0, bm.bmWidth, bm.bmHeight, SRCCOPY);
        SelectObject(hMemDC, hOldbm);
    }
    DeleteDC(hMemDC);
}

// ??????? ????????? ?????????
void DrawPlatform(HDC hDC, platform* plat)
{
    // ??????? ????? ??? ?????????
    HBRUSH hBrush = CreateSolidBrush(RGB(150, 75, 0)); // ?????????? ????
    HBRUSH hOldBrush = (HBRUSH)SelectObject(hDC, hBrush);

    // ?????? ????????????? ?????????
    Rectangle(hDC, plat->x, plat->y, plat->x + plat->width, plat->y + plat->height);

    // ??????????????? ?????
    SelectObject(hDC, hOldBrush);
    DeleteObject(hBrush);

    // ???? ???? ???????? - ?????? ??
    if (plat->hBitmap != NULL)
    {
        BITMAP bm;
        GetObject(plat->hBitmap, sizeof(BITMAP), &bm);
        HDC hMemDC = CreateCompatibleDC(hDC);
        SelectObject(hMemDC, plat->hBitmap);
        BitBlt(hDC, plat->x, plat->y, plat->width, plat->height, hMemDC, 0, 0, SRCCOPY);
        DeleteDC(hMemDC);
    }
}

void ShowRacketAndBall()
{
    // ????????? ????
    if (currentLocation.background != NULL)
    {
        ShowBitmap(window.context, 0, 0, window.width, window.height, currentLocation.background);
    }
    else
    {
        // ???? ???? ???, ???????? ??????
        HBRUSH hBrush = CreateSolidBrush(RGB(0, 0, 0));
        RECT rect = { 0, 0, window.width, window.height };
        FillRect(window.context, &rect, hBrush);
        DeleteObject(hBrush);
    }

    // ????????? ???? ????????
    for (auto& plat : currentLocation.platforms)
    {
        DrawPlatform(window.context, &plat);
    }

    // ????????? ??????
    if (racket.hBitmap != NULL)
    {
        ShowBitmap(window.context, racket.x, racket.y, racket.width, racket.height, racket.hBitmap);
    }
    else
    {
        // ???? ???????? ???, ?????? ??????? ?????????????
        HBRUSH hBrush = CreateSolidBrush(RGB(255, 0, 0));
        HBRUSH hOldBrush = (HBRUSH)SelectObject(window.context, hBrush);
        Rectangle(window.context, racket.x, racket.y, racket.x + racket.width, racket.y + racket.height);
        SelectObject(window.context, hOldBrush);
        DeleteObject(hBrush);
    }
}

void LimitRacket()
{
    // ??????????? ?? ???????????
    racket.x = max(racket.x, 0.0f);
    racket.x = min(racket.x, (float)window.width - racket.width);

    // ??????????? ?? ????????? (????? ?? ?????? ??????? ??????)
    racket.y = max(racket.y, -racket.height * 2.0f);
}

void InitWindow()
{
    SetProcessDPIAware();

    // ???????? ???? ? ??????? ???????
    window.hWnd = CreateWindowW(L"edit", L"", WS_POPUP | WS_VISIBLE | WS_MAXIMIZE,
        0, 0, 0, 0, 0, 0, 0, 0);

    RECT r;
    GetClientRect(window.hWnd, &r);
    window.device_context = GetDC(window.hWnd);
    window.width = r.right - r.left;
    window.height = r.bottom - r.top;
    window.context = CreateCompatibleDC(window.device_context);
    SelectObject(window.context, CreateCompatibleBitmap(window.device_context, window.width, window.height));
}

int APIENTRY wWinMain(_In_ HINSTANCE hInstance,
    _In_opt_ HINSTANCE hPrevInstance,
    _In_ LPWSTR    lpCmdLine,
    _In_ int       nCmdShow)
{
    InitWindow();
    InitGame();

    ShowCursor(FALSE); // ???????? ??????

    while (!GetAsyncKeyState(VK_ESCAPE))
    {
        // ?????????? ??????
        UpdatePhysics();

        // ????????? ?????
        ProcessInput();

        // ???????????
        LimitRacket();

        // ?????????
        ShowRacketAndBall();
        ShowScore();
        BitBlt(window.device_context, 0, 0, window.width, window.height, window.context, 0, 0, SRCCOPY);

        // ????????
        Sleep(16);
    }

    return 0;
}
